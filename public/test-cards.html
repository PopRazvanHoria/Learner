<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test on Cards</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="main-shell">
        <section class="app-card" style="grid-column: 1 / -1;">
            <div class="app-card-inner">
                <nav class="top-nav" aria-label="Main navigation">
                    <a class="top-nav-link" href="index.html">Home</a>
                    <a class="top-nav-link" href="create-card.html">Create cards</a>
                    <a class="top-nav-link" href="learn-cards.html">Learn mode</a>
                    <a class="top-nav-link active" href="test-cards.html">Test yourself</a>
                </nav>

                <header class="app-header">
                    <div>
                        <div class="app-title">Test yourself</div>
                        <div class="app-subtitle">Hide key regions and see what you can recall.</div>
                    </div>
                </header>

                <div class="card-stage">
                    <div id="card-container" class="card-stage-main">
                        <!-- Cards will be dynamically loaded here -->
                    </div>
                    <div class="card-stage-actions">
                        <button id="start-over-btn" class="subtle-btn">Start over</button>
                        <button id="next-card-btn" class="primary-btn">Next card</button>
                    </div>
                    <p class="info-note">Use the blurred regions as prompts, then reveal the full card image.</p>
                </div>
            </div>
        </section>
    </div>
    <script>
        let currentIndex = 0;

        async function fetchCard(index) {
            try {
                console.log(`Fetching card at index ${index}`); // Debugging line
                const response = await fetch(`/get-card/${index}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const card = await response.json();
                console.log('Fetched card:', card); // Debugging line
                displayCard(card);
            } catch (error) {
                console.error('Error fetching card:', error);
                document.getElementById('card-container').innerHTML = '<p>No more cards available</p>';
            }
        }

        function displayCard(card) {
            const cardContainer = document.getElementById('card-container');
            console.log('Displaying card:', card); // Debugging line
            cardContainer.innerHTML = `
                <div class="test-image-wrapper" id="test-image-wrapper">
                    <img src="${card.imagePath}" alt="Card Image" onerror="handleImageError(this)">
                </div>
            `;

            const imageWrapper = document.getElementById('test-image-wrapper');
            card.blurRegions.forEach(region => {
                const blurRegion = document.createElement('canvas');
                blurRegion.className = 'test-blur-region';
                blurRegion.style.left = region.left;
                blurRegion.style.top = region.top;
                blurRegion.style.width = region.width;
                blurRegion.style.height = region.height;
                blurRegion.width = parseInt(region.width);
                blurRegion.height = parseInt(region.height);
                addNoise(blurRegion);
                imageWrapper.appendChild(blurRegion);
            });
        }

        function addNoise(canvas) {
            const ctx = canvas.getContext('2d');
            const blockSize = 10; // Size of each pixel block
            for (let y = 0; y < canvas.height; y += blockSize) {
                for (let x = 0; x < canvas.width; x += blockSize) {
                    const red = Math.random() * 128 + 64; // Lower saturation
                    const green = Math.random() * 128 + 64; // Lower saturation
                    const blue = Math.random() * 128 + 64; // Lower saturation
                    ctx.fillStyle = `rgb(${red}, ${green}, ${blue})`;
                    ctx.fillRect(x, y, blockSize, blockSize);
                }
            }
        }

        function handleImageError(img) {
            console.error('Error loading image:', img.src); // Debugging line
            img.src = 'placeholder.png'; // Fallback image
        }

        function nextCard() {
            currentIndex++;
            fetchCard(currentIndex);
        }

        function startOver() {
            currentIndex = 0;
            fetchCard(currentIndex);
        }

        document.getElementById('next-card-btn').addEventListener('click', nextCard);
        document.getElementById('start-over-btn').addEventListener('click', startOver);

        fetchCard(currentIndex);
    </script>
</body>
</html>

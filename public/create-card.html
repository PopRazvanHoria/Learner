<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Card</title>
    <style>
        #generated-image {
            border: 1px solid #000;
            display: none;
            position: relative;
        }
        .blur-region {
            position: absolute;
            border: 2px dashed #000;
            background: rgba(255, 255, 255, 0.8);
        }
        #generated-image-container {
            position: relative;
        }
        .slider-container {
            margin-top: 10px;
            display: none; /* Initially hidden */
        }
        #blur-preview {
            border: 1px solid #000;
            margin-top: 10px;
            width: 200px;
            height: 200px;
            display: none; /* Initially hidden */
        }
    </style>
</head>
<body>
    <h1>Create a New Card</h1>
    <form id="create-card-form">
        <label for="card-type">Card Type:</label>
        <select id="card-type" name="card-type">
            <option value="text" selected>Text</option>
            <option value="image">Image</option>
        </select>
        <div id="text-card-input">
            <label for="text-content">Text Content:</label>
            <textarea id="text-content" name="text-content"></textarea>
            <button type="button" id="generate-image-btn">Generate Image</button>
        </div>
        <div id="image-card-input" style="display: none;">
            <label for="image-content">Image Content:</label>
            <input type="file" id="image-content" name="image-content">
        </div>
        <div id="generated-image-container">
            <img id="generated-image" src="" alt="Generated Image">
        </div>
        <div class="slider-container" id="blur-width-container">
            <label for="blur-width">Blur Width:</label>
            <input type="range" id="blur-width" name="blur-width" min="10" max="200" value="50">
            <span id="blur-width-value">50</span>px
        </div>
        <div class="slider-container" id="blur-height-container">
            <label for="blur-height">Blur Height:</label>
            <input type="range" id="blur-height" name="blur-height" min="10" max="200" value="50">
            <span id="blur-height-value">50</span>px
        </div>
        <canvas id="blur-preview" width="200" height="200"></canvas>
        <button type="button" id="clear-blur-regions-btn">Clear Blur Regions</button>
        <button type="submit">Create Card</button>
    </form>
    <script>
        document.getElementById('card-type').addEventListener('change', function() {
            const textCardInput = document.getElementById('text-card-input');
            const imageCardInput = document.getElementById('image-card-input');
            if (this.value === 'text') {
                textCardInput.style.display = 'block';
                imageCardInput.style.display = 'none';
            } else {
                textCardInput.style.display = 'none';
                imageCardInput.style.display = 'block';
            }
        });

        document.getElementById('generate-image-btn').addEventListener('click', function() {
            const textContent = document.getElementById('text-content').value;
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 400;
            canvas.height = 300;
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#000';
            ctx.font = '20px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            const maxWidth = canvas.width - 20; // Padding of 10px on each side
            const lineHeight = 24; // Line height for the text
            const x = canvas.width / 2;
            const y = canvas.height / 2;

            wrapText(ctx, textContent, x, y, maxWidth, lineHeight);

            const dataURL = canvas.toDataURL();
            const generatedImage = document.getElementById('generated-image');
            generatedImage.src = dataURL;
            generatedImage.style.display = 'block';

            // Show the blur preview and sliders
            document.getElementById('blur-preview').style.display = 'block';
            document.getElementById('blur-width-container').style.display = 'block';
            document.getElementById('blur-height-container').style.display = 'block';
            updateBlurPreview();
        });

        function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
            const words = text.split(' ');
            let line = '';
            let testLine = '';
            let testWidth = 0;
            let lines = [];
            for (let n = 0; n < words.length; n++) {
                testLine = line + words[n] + ' ';
                testWidth = ctx.measureText(testLine).width;
                if (testWidth > maxWidth && n > 0) {
                    lines.push(line);
                    line = words[n] + ' ';
                } else {
                    line = testLine;
                }
            }
            lines.push(line);

            const totalHeight = lines.length * lineHeight;
            let startY = y - totalHeight / 2;

            for (let i = 0; i < lines.length; i++) {
                ctx.fillText(lines[i], x, startY);
                startY += lineHeight;
            }
        }

        document.getElementById('image-content').addEventListener('change', function(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const generatedImage = document.getElementById('generated-image');
                generatedImage.src = e.target.result;
                generatedImage.style.display = 'block';

                // Show the blur preview and sliders
                document.getElementById('blur-preview').style.display = 'block';
                document.getElementById('blur-width-container').style.display = 'block';
                document.getElementById('blur-height-container').style.display = 'block';
                updateBlurPreview();
            };
            reader.readAsDataURL(file);
        });

        document.getElementById('generated-image').addEventListener('click', function(event) {
            const rect = this.getBoundingClientRect();
            const blurWidth = parseInt(document.getElementById('blur-width').value);
            const blurHeight = parseInt(document.getElementById('blur-height').value);
            const x = event.clientX - rect.left - blurWidth / 2;
            const y = event.clientY - rect.top - blurHeight / 2;
            const blurRegion = document.createElement('div');
            blurRegion.className = 'blur-region';
            blurRegion.style.left = `${x}px`;
            blurRegion.style.top = `${y}px`;
            blurRegion.style.width = `${blurWidth}px`;
            blurRegion.style.height = `${blurHeight}px`;
            document.getElementById('generated-image-container').appendChild(blurRegion);
        });

        document.getElementById('blur-width').addEventListener('input', function() {
            document.getElementById('blur-width-value').textContent = this.value;
            requestAnimationFrame(updateBlurPreview);
        });

        document.getElementById('blur-height').addEventListener('input', function() {
            document.getElementById('blur-height-value').textContent = this.value;
            requestAnimationFrame(updateBlurPreview);
        });

        function updateBlurPreview() {
            const blurWidth = document.getElementById('blur-width').value;
            const blurHeight = document.getElementById('blur-height').value;
            const previewCanvas = document.getElementById('blur-preview');
            const ctx = previewCanvas.getContext('2d');
            const centerX = previewCanvas.width / 2;
            const centerY = previewCanvas.height / 2;
            const startX = centerX - blurWidth / 2;
            const startY = centerY - blurHeight / 2;
            ctx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);

            // Add a snippet of the created card as the background
            const generatedImage = document.getElementById('generated-image');
            if (generatedImage.src) {
                const img = new Image();
                img.src = generatedImage.src;
                img.onload = function() {
                    const snippetWidth = Math.min(img.width, previewCanvas.width);
                    const snippetHeight = Math.min(img.height, previewCanvas.height);
                    const snippetX = (img.width - snippetWidth) / 2;
                    const snippetY = (img.height - snippetHeight) / 2;
                    ctx.drawImage(img, snippetX, snippetY, snippetWidth, snippetHeight, 0, 0, previewCanvas.width, previewCanvas.height);
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                    ctx.fillRect(startX, startY, blurWidth, blurHeight);
                    ctx.strokeStyle = '#000';
                    ctx.setLineDash([5, 3]);
                    ctx.strokeRect(startX, startY, blurWidth, blurHeight);
                };
            } else {
                // Add piglatin text as the background
                ctx.fillStyle = '#000';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                const piglatinText = 'Igpay Atinlay Extextay'; // Example piglatin text
                ctx.fillText(piglatinText, centerX, centerY);
            }
        }

        document.getElementById('clear-blur-regions-btn').addEventListener('click', function() {
            const blurRegions = document.getElementsByClassName('blur-region');
            while (blurRegions.length > 0) {
                blurRegions[0].parentNode.removeChild(blurRegions[0]);
            }
        });

        document.getElementById('create-card-form').addEventListener('submit', function(event) {
            event.preventDefault();
            const generatedImage = document.getElementById('generated-image').src;
            const blurRegions = Array.from(document.getElementsByClassName('blur-region')).map(region => ({
                left: region.style.left,
                top: region.style.top,
                width: region.style.width,
                height: region.style.height
            }));
            const frequencyCategory = 0; // Initial frequency category

            fetch('/save-card', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    imageData: generatedImage,
                    blurRegions,
                    frequencyCategory
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(err.details || 'Unknown error'); });
                }
                return response.json();
            })
            .then(data => {
                // Clear the shown image and blur regions
                document.getElementById('generated-image').style.display = 'none';
                document.getElementById('generated-image').src = '';
                document.getElementById('clear-blur-regions-btn').click();

                // Show the blur preview
                document.getElementById('blur-preview').style.display = 'block';
                updateBlurPreview();
            })
            .catch(error => {
                console.error('Error saving card:', error);
            });
        });

        // Test the create-test-folder endpoint
        fetch('/create-test-folder', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            console.log(data.message);
        })
        .catch(error => {
            console.error('Error creating test folder:', error);
        });

        // Initial update of the blur preview
        updateBlurPreview();
    </script>
</body>
</html>
